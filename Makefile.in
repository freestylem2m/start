#####################################################################
#
# Makefile for netmanage process
#
# Adjust
#####################################################################

WARNINGS=-Wall -Wconversion -Werror -Wshadow -Wunused-parameter
#EXTRA_WARNINGS=-Wenum-compare -Warray-bounds
FEATURES=-fshort-enums -fbounds-check

# Configure debugging or Optimization
DEBUG=-g -O0
#RELEASE=-DNDEBUG -O2

# Override CC to use the mips compiler.  Remember to turn of "EXTRA_WARNINGS" which are
# unsupposed on gcc-3.4.2
CC=/opt/buildroot-gcc342/bin/mipsel-linux-gcc
#ARCH=-m32

INCLUDES=-Isrc
CFLAGS=$(DEBUG) $(RELEASE) $(INCLUDES) $(EXTRA_FLAGS) $(ARCH) $(WARNINGS) $(EXTRA_WARNINGS) $(FEATURES)
LDFLAGS=$(DEBUG)

#.SILENT:

MANAGER_SOURCE=$(wildcard src/*.c)
MANAGER_OBJECTS=$(MANAGER_SOURCE:.c=.o)

DRIVER_SOURCE=$(wildcard src/drivers/*/*.c)
DRIVER_CONFIGS=$(wildcard src/drivers/*/*.w)
DRIVER_OBJECTS=$(DRIVER_SOURCE:.c=.o)

# Override default '.w.c:' build rule to TEXT..
.w.c:
	@true

netmanage: .depend $(MANAGER_OBJECTS) $(DRIVER_OBJECTS)
	$(CC) $(LDFLAGS) -o $@ $(MANAGER_OBJECTS) $(DRIVER_OBJECTS)
	cp netmanage /home/freestyle/fme

clean:
	/bin/rm -f .depend $(MANAGER_OBJECTS) $(DRIVER_OBJECTS) netmanage src/driver_config.h src/driver_setup.h

distclean: clean
	/bin/rm -f config.h config.log config.status configure Makefile
	/bin/rm -rf autom4te.cache .ycm_extra_conf.pyc

.depend: Makefile
	find . -type f -name "*.c" | sed 's/^.\/\(.*\)\.c/\1.o: \1.c \1.h/' > .depend

src/driver.c: src/driver_config.h src/driver_setup.h

src/driver_config.h: $(DRIVER_SOURCE)
	for config in $(DRIVER_SOURCE:.c=.h); do if [ -f "$$config" ]; then echo "#include \"$${config#*/}\""; fi; done > $@

src/driver_setup.h: $(DRIVER_CONFIGS)
	for config in $(DRIVER_CONFIGS); do echo "#include \"$${config#*/}\""; done > $@

-include .depend
