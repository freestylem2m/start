
WARNINGS=-Wall -Wenum-compare -Wconversion -Werror -Warray-bounds
FEATURES=-O0 -fshort-enums -fbounds-check
DEBUG=-g
#DEBUG=-DNDEBUG
INCLUDES=-Isrc

CFLAGS=$(DEBUG) $(INCLUDES) $(WARNINGS) $(FEATURES)
LDFLAGS=-g

.SILENT:

MANAGER_SOURCE=$(wildcard src/*.c)
MANAGER_OBJECTS=$(MANAGER_SOURCE:.c=.o)

DRIVER_SOURCE=$(wildcard src/drivers/*/*.c)
DRIVER_CONFIGS=$(wildcard src/drivers/*/*.w)
DRIVER_OBJECTS=$(DRIVER_SOURCE:.c=.o)

# Override default '.w.c:' build rule to TEXT..
.w.c:
	@echo

netmanage: .depend $(MANAGER_OBJECTS) $(DRIVER_OBJECTS)
	$(CC) $(LDFLAGS) -o $@ $(MANAGER_OBJECTS) $(DRIVER_OBJECTS)

clean:
	/bin/rm -f .depend $(MANAGER_OBJECTS) $(DRIVER_OBJECTS) netmanage src/driver_config.h src/driver_setup.h

distclean: clean
	/bin/rm -f config.h config.log config.status configure Makefile
	/bin/rm -rf autom4te.cache .ycm_extra_conf.pyc

.depend: Makefile
	find . -type f -name "*.c" | sed 's/^.\/\(.*\)\.c/\1.o: \1.c \1.h/' > .depend

src/driver.c: src/driver_config.h src/driver_setup.h

src/driver_config.h: $(DRIVER_SOURCE)
	for config in $(DRIVER_SOURCE:.c=.h); do if [ -f "$$config" ]; then echo "#include \"$${config#*/}\""; fi; done > $@

src/driver_setup.h: $(DRIVER_CONFIGS)
	for config in $(DRIVER_CONFIGS); do echo "#include \"$${config#*/}\""; done > $@

-include .depend
